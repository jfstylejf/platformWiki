## 平台组件

### 1.1 环境变量

1. 环境jdk  /usr/java/jdk1.8.0_131
2. Sonar jdk  /home/fdse/user/Component/sonar/sonarJava/jdk-11.0.4

3. Maven  /usr/local/maven3.5.4

4. Findbugs  /home/fdse/findbugs-3.0.1

5. Sonar-scanner /opt/sonar/sonar-scanner-cli-4.0.0.1744-linux/sonar-scanner-4.0.0.1744-linux

### 1.2数据库组件

1. redis

   - 组件位置 /usr/local/redis-5.0.0

   - 组件安装

     ```shell
     wget http://download.redis.io/releases/redis-5.0.0.tar.gz
     tar xzf redis-5.0.0.tar.gz
     cd redis-5.0.0
     make
     ```

   - 修改配置文件

     ```shell
     daemonize yes
     requirepass redis #修改密码
     # bind 127.0.0.1 注释掉bind 127.0.0.1可以使所有的ip访问redis
     protected-mode no
     ```

   - 组件功能

​               将数据存储内存中，能够提高数据访问速度

​               提供分布式锁的机制

***



2. Mysql

   - 组件安装

     ```shell
     wget http://dev.mysql.com/get/mysql57-community-release-el7-8.noarch.rpm
     yum localinstall mysql57-community-release-el7-8.noarch.rpm
     yum repolist enabled | grep "mysql.*-community.*"
     yum install mysql-community-server
     ```

   - 修改配置

     ```shell
     vim /etc/my.cnf
     \#skip-grant-tables
     secure_file_priv=''
     ```

   - sql语句修改权限

     ```sql
     set global validate_password_policy=0;
     
     set global validate_password_length=1;
     
     alter user user() identified by "root";
     
     GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'root' WITH GRANT OPTION;
     
     update user set authentication_string=password('root')  where User='root';
     
     flush privileges;
     ```

   - 组件功能 

     存储服务数据

   ***

   

3. PostGre

   - 版本10  

     考虑到兼容问题所以选择了10

   - 组件安装

     ```shell
     yum install <https://download.postgresql.org/pub/repos/yum/reporpms/EL-7x86_64/pgdg-redhat-repo-latest.noarch.rpm>
     
     yum install postgresql10
     
     yum install postgresql10-server
     
     /usr/pgsql-10/bin/postgresql-10-setup initdb
     
     systemctl enable postgresql-10
     ```

   - 组件简单操作

     ```shell
     进入数据库操作页面 su postgres
     
     数据库列表查看 psql -l
     
     创建用户 CREATE USER name;
     
     删除用户 DROP USER name;
     
     创建数据库 CREATE DATABASE sonar OWNER sonar
     
     进入数据库 psql sonar
     
     退出数据库 \q
     ```

   - 组件配置参照  

     /var/lib/pgsql/10/data下的pg_hba.conf 和 postgresql.conf

***



4. 网关组件

   - 安装cassandra

     - 安装

       ```
       tar -xvf cassandra-3.9-bin.tar.gz
       
       mkdir /var/lib/cassandra/data 
       
       mkdir /var/lib/cassandra/commitlog
       
       mkdir /var/lib/cassandra/saved_caches
       ```

     - 配置

       ```
       cassandra.yaml的配置
       
       data_file_directories:
       
       /var/lib/cassandra/data                                                 
       
       commitlog_directory: /var/lib/cassandra/commitlog
       
       saved_caches_directory: /var/lib/cassandra/saved_caches
       
       listen_address: 127.0.0.1
       
       rpc_address: 127.0.0.1
       ```

     - 环境变量设置

       ```
       export PATH=$PATH:/opt/apache-cassandra-3.9/bin/
       ```

     - 启动

       ```
       cassandra -f -R &
       ```

   - 安装kong

     - 安装

       ```sehll
       rpm -ivh kong-community-edition-0.12.0.el7.noarch.rpm
       ```

     - 修改配置

       复制服务器的kong.conf

     - 启动

       ```
       kong start -c /etc/kong/kong.conf
       ulimit -n  4096
       kong migrations up
       ```

   - 安装kong-dashboard

     - 安装npm

       ```
       wget https://nodejs.org/dist/v10.9.0/node-v10.9.0-linux-x64.tar.xz
       tar xvf  node-v10.9.0-linux-x64.tar.xz       // 解压
       cd node-v10.9.0-linux-x64/                // 进入解压目录
       ./bin/node -v                   // 执行node命令 查看版本
       ln -s /usr/software/nodejs/bin/npm   /usr/local/bin/ 
       ln -s /usr/software/nodejs/bin/node   /usr/local/bin/
       ```

     - 安装kong-dashboard

       ```
       npm install -g kong-dashboard
       ln -s /usr/local/node-v10.8.0-linux-x64/bin/kong-dashboard /usr/local/bin/kong-dashboard
       nohup kong-dashboard start --kong-url http://127.0.0.1:8011 --port 8080 --basic-auth u1=p1 &
       ```

***



5. 消息中间件组件(kafka)

   - 下载及启动

     ```
     wget https://mirrors.tuna.tsinghua.edu.cn/apache/kafka/1.1.0/kafka_2.11-1.1.0.tgz
     
     tar -xzf kafka_2.11-1.1.0.tgz
     
     cd kafka_2.11-1.1.0
     
     nohup bin/zookeeper-server-start.sh config/zookeeper.properties >  zookeeper.log 2>&1 &
     
     nohup bin/kafka-server-start.sh config/server.properties  >  kafka.log 2>&1 &
     ```

   - 配置文件

     Kafka的配置文件参照 文件位于/usr/kafka_2.11-1.1.0 中的 zookeeper.properties 和 server.properties

   - 创建/删除topic

     ```
      bin/kafka-topics.sh --create --zookeeper localhost:2182 --replication-factor 1 --partitions 1 --topic ProjectManager
     
      bin/kafka-topics.sh --delete --zookeeper localhost:2182 --topic ProjectManager
     ```

   - 查看topic列表  

     ```
     ./bin/kafka-topics.sh --list --zookeeper localhost:2182
     ```

   - 查看topic的历史消息

     ```
     bin/kafka-console-consumer.sh --bootstrap-server 10.141.221.85:9092 --topic ProjectManager --from-beginning
     ```

***



6. 扫描组件
   - Clone工具
   - Sonar工具

***



7. 其他组件
   - Anaconda
   - Git

***



## 微服务

### account-service

负责用户的登录、注册以及其它服务接口的认证，认证的代码写在拦截器中，在相应服务的interceptor包下

  用户的token存储在redis中，token的key是login

  数据库account表中的用户密码是注册时输入的用户名+密码后取MD5后加密的值，所以不要在account表中直接改密码，是没有用的。

### project-manager

负责项目的添加、删除和查询。

​      项目的添加会和思聪的服务交互，主要就是向ProjectManager这个topic发送消息，让思聪的服务去下载这个项目

​         同时会监听RepoManager这个topic的消息，根据下载的成败更新project表的状态。

​      项目的删除除了删除project表的一条，还需要把这个项目所有关联的信息都删除，相关联的表有issue,rawIssue,location,scan,event,scan_result,ignore_record,tagged,repo_measure,package_measure,bug_recommendation

​      其中issue,rawIssue,location,scan_result,tagged会调用issue-service中的删除接口，scan会调用scan-service的删除接口，event会调用event-service的删除接口

​      repo_measure,package_measure的级联删除应该写到measure-service中，但还没有写，后面需要实现

​      bug_recommendation的删除需要调用刘霜推荐服务的删除接口

### scan-service

 负责项目的缺陷扫描，结果文件的解析，以及调用issue-service将缺陷数据保存到数据库

​     每一次扫描都会有一条扫描的记录保存到scan表中

​     项目的扫描会被3种情况触发

​          1、用户前端选择某一个commit

​          2、项目有新的commit更新，思聪通过Scan这个topic发送过来

​          3、项目添加并且下载完成后，思聪把这个项目的所有commit的列表发送到UpdateCommit这个topic

 

​     其中第三种情况会对commit列表进行过滤，过滤功能的实现在component包下，一个接口，3个实现类，分别对应3个不同的过滤策略，目前采用的是每天扫一个的策略，如果需要调整，则换一个实现类注入到KafkaServiceImpl中

 

​     扫描分为2种，BUG的扫描和Clone的扫描，BUG使用的工具是FingBugs，Clone使用的工具是克隆小组实现的SAGA。

​     扫描的流程: 检查扫描commit的合法性（扫过没？时间上是不是靠后？），获取该commit快照下的项目路径，调用扫描工具，分析结果文件，保存缺陷数据，插入scan记录，更新项目扫描状态。

​     工具的调用脚本以及项目的编译脚本存放地址：

​          85   /home/fdse/user/issueTracker/bin/

​          80   /home/fdse/issueTracker/bin/   

​      FindBugs检测结果文件的存放地址：

​          85  /home/fdse/user/issueTracker/resultfile

​          80  /home/fdse/issueTracker/resultfile

​      Clone检测工具SAGA的结果文件存放地址

​          85  /home/fdse/user/issueTracker/saga-cpu/res

​          80  /home/fdse/issueTracker/saga-cpu/res

 

​      扫描开始前会使用Redis的分布式锁，锁的粒度是repo_id，目前是串行，后面准备改为多线程。

 

### issue-service

负责issue的映射、查询和删除,首页的dashboard以及趋势图

  相关的数据库表有issue,rawIssue,location

  需要重点注意的是mapping相关的代码，位于service包下,对应的接口是MappingService,父类BaseMappingServiceImpl实现了这个接口，主要存放了一些通用的方法和field供子类使用

  关键的方法mapping父类并没有实现，由2个子类重写

  2个子类BugMappingServiceImpl和CloneMappingServiceImpl分别负责BUG类型的映射和Clone类型的映射，以及最新的SoanrMappingServiceImpl

 

  映射逻辑中包含的额外职责主要有：

​             1、新增的issue根据rank打tag

​             2、修复的issue打sloved的tag

​             3、根据新增、修复、剩余的issue的个数更新dashboard

​             4、将修复的缺陷信息发给solvedBug这个topic,给刘霜的修复推荐服务使用。（注意该功能只在developer分支[85]上实现了，master分支[80]并未实现,master分支上是直接将修复信息保存到bug_recommendation表，后面需要统一）

​             4、将commit,developer,新增、修复和剩余issue的个数保存到scan_result表

 

### measure-service

负责度量信息解析、保存和查询的服务

​    度量信息的解析使用的是javancss这个工具，整个工作流程是获取项目根目录路径、调用javancss得到xml结果文件，解析结果文件将度量数据封装到定义的数据结构中，最后从中挑选需要的数据保存到数据库

​    度量服务对应的表有2个，项目级别的度量信息表repo_measure   包级别的度量信息表package_measure

​    结果文件的存放地址：

​         85   /home/fdse/user/issueTracker/javancss/bin/

​         80   /home/fdse/issueTracker/javancss/bin/

​     度量页面所使用的查询接口主要有3个，项目级别的度量信息、模块级别（包）级别的度量信息的查询和活跃度信息的查询。

​     其中活跃度信息来自于调用写有git命令的shell脚本，调用的实现都在utill包下的GitUtill类中

​     脚本文件的存放地址：

​         85   /home/fdse/user/issueTracker/bin/

​         80   /home/fdse/issueTracker/bin/     

​     analyaer包、handler包和service包下是度量服务实现的关键，需要重点review代码

 

### clone-service

主要负责clone 工具的调用，以及产生相应的clone度量信息。

 

###  event-service

页面首页右上角气泡对应的服务,作用是给用户显示事件，对应的数据库表是event

BUG类型时对应的事件有 bug的新增和修复

Clone类型对应的事件有 clone组的新增和修复 clone instance的新增和修复

  该服务只负责事件的插入、删除和查询，其中插入是在issue-service中mapping时调用的，删除时是在project-manager中删除项目时调用的，查询是由前端直接调用的

 

### tag-service

负责issue标签的添加、删除和查询

对应的表为tagged,tag

 

### 各个服务如何启动

1.  Jar包的位置  /home/fdse/user/issueTracker

2.  启动方式 

   到/home/fdse/user/issueTracker 下执行命令 ./issueTracker-demo.sh start external

​        同时启动diff服务bug-recommendation服务

3. 服务停止

​        执行./issueTracker-demo.sh stop

 

4. 服务的配置文件地址

​        /home/fdse/user/issueTracker/config

 

5. 程序执行脚本文件地址

​        /home/fdse/user/issueTracker/bin

 